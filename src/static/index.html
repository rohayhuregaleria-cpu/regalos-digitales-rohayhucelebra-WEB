<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/png" href="/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Rohayhu Celebra! - Completo</title>
    <style>
        :root {
            --naranja-vitalidad: #F26200;
            --gris-profundo: #393d41;
            --magenta: #CB3D79;
            --turquesa: #09869b;
            --verde-armonia: #59a068;
            --texto-blanco: #FFFFFF;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--gris-profundo) 0%, #2c3e50 100%);
            color: var(--texto-blanco);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px; margin: 0 auto; background: rgba(255, 255, 255, 0.1);
            border-radius: 20px; padding: 40px; backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2); box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }
        .header { text-align: center; margin-bottom: 40px; }
        .logo { margin-bottom: 20px; }
        .rohayhu { font-weight: 700; font-size: 1.2em; text-transform: uppercase; letter-spacing: 2px; color: var(--texto-blanco); }
        .celebra { font-weight: 700; font-style: italic; font-size: 3em; color: var(--naranja-vitalidad); text-shadow: 0 0 20px var(--naranja-vitalidad); margin-top: -10px; }
        .subtitle { font-size: 1.1em; opacity: 0.8; margin-top: 10px; }
        .tabs { display: flex; margin-bottom: 30px; background: rgba(255, 255, 255, 0.1); border-radius: 15px; padding: 5px; }
        .tab { flex: 1; padding: 15px 20px; text-align: center; border-radius: 10px; cursor: pointer; transition: all 0.3s ease; font-weight: 600; border: none; background: transparent; color: var(--texto-blanco); }
        .tab.active { background: linear-gradient(45deg, var(--naranja-vitalidad), var(--magenta)); box-shadow: 0 5px 15px rgba(242, 98, 0, 0.3); }
        .tab:hover:not(.active) { background: rgba(255, 255, 255, 0.1); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .form-section { background: var(--gris-profundo); border-radius: 15px; padding: 30px; margin-bottom: 30px; border: 1px solid rgba(255, 255, 255, 0.1); }
        .form-group { margin-bottom: 25px; }
        label { display: block; font-weight: 600; margin-bottom: 8px; color: var(--turquesa); font-size: 1.1em; }
        input[type="text"], input[type="email"], input[type="url"], select {
            width: 100%; padding: 15px; border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px; background: var(--gris-profundo); color: var(--texto-blanco);
            font-size: 1em; transition: all 0.3s ease;
        }
        input[type="text"]:focus, input[type="email"]:focus, input[type="url"]:focus, select:focus {
            outline: none; border-color: var(--naranja-vitalidad); background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 0 15px rgba(242, 98, 0, 0.3);
        }
        input::placeholder { color: rgba(255, 255, 255, 0.6); }
        .checkbox-group { display: flex; align-items: center; gap: 15px; background: var(--gris-profundo); padding: 15px; border-radius: 10px; }
        .checkbox-group input[type="checkbox"] { width: auto; transform: scale(1.5); }
        .items-controls { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .add-item-btn { padding: 10px 15px; background: var(--verde-armonia); color: var(--texto-blanco); border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; }
        .add-item-btn:hover { background: #4a8a57; transform: translateY(-2px); }
        .item { display: flex; gap: 15px; align-items: center; margin-bottom: 15px; padding: 15px; background: var(--gris-profundo); border-radius: 10px; border: 1px solid rgba(255, 255, 255, 0.2); }
        .item-label { font-weight: bold; color: var(--naranja-vitalidad); min-width: 80px; }
        .item input { flex: 1; margin: 0; }
        .remove-item-btn { background: var(--magenta); color: var(--texto-blanco); border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .remove-item-btn:hover { background: #a8325f; }
        .action-button {
            width: 100%; padding: 18px; font-size: 1.2em; font-weight: bold;
            background: linear-gradient(45deg, var(--naranja-vitalidad), var(--magenta));
            color: var(--texto-blanco); border: none; border-radius: 15px; cursor: pointer;
            transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 1px;
            position: relative; overflow: hidden;
        }
        .action-button:hover { transform: translateY(-3px); box-shadow: 0 15px 30px rgba(242, 98, 0, 0.4); }
        .action-button:active { transform: translateY(-1px); }
        .action-button:disabled { opacity: 0.6; cursor: not-allowed; transform: none; box-shadow: none; }
        .result-section { margin-top: 30px; padding: 20px; border-radius: 15px; border: 2px solid; display: none; }
        .result-success { background: rgba(89, 160, 104, 0.2); border-color: var(--verde-armonia); color: var(--verde-armonia); }
        .result-error { background: rgba(203, 61, 121, 0.2); border-color: var(--magenta); color: var(--magenta); }
        .result-info { background: rgba(9, 134, 155, 0.2); border-color: var(--turquesa); color: var(--turquesa); }
        .loading { display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top-color: var(--texto-blanco); animation: spin 1s ease-in-out infinite; margin-right: 10px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .icon { font-size: 1.5em; margin-right: 10px; }
        .health-check { text-align: center; margin-bottom: 20px; }
        .health-button { background: var(--turquesa); color: var(--texto-blanco); border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 0.9em; transition: all 0.3s ease; }
        .health-button:hover { background: #0a7a8a; transform: translateY(-2px); }
        .generated-link { word-wrap: break-word; font-family: 'Courier New', Courier, monospace; background: var(--gris-profundo); padding: 15px; border-radius: 10px; border: 2px dashed var(--turquesa); margin: 15px 0; }
        .copy-button { background: var(--turquesa); color: var(--texto-blanco); border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; }
        .copy-button:hover { background: #0a7a8a; transform: translateY(-2px); }
        @media (max-width: 768px) {
            .container { padding: 20px; margin: 10px; }
            .celebra { font-size: 2.5em; }
            .tabs { flex-direction: column; }
            .items-controls { flex-direction: column; }
            .item { flex-direction: column; align-items: stretch; }
            .item-label { min-width: auto; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">
                <div class="rohayhu">ROHAYHU</div>
                <div class="celebra">Celebra!</div>
            </div>
            <div class="subtitle">Dashboard Completo de Automatizaci√≥n de Regalos Digitales</div>
        </div>

        <div class="health-check">
            <button class="health-button" onclick="checkHealth()">üîç Verificar Estado del Sistema</button>
            <div id="health-result"></div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('generator')">
                <span class="icon">üîó</span>Generar Enlaces
            </button>
            <button class="tab" onclick="switchTab('sender')">
                <span class="icon">üìß</span>Enviar Regalos
            </button>
        </div>

        <!-- Tab: Generador de Enlaces -->
        <div id="generator-tab" class="tab-content active">
            <div class="form-section">
                <h2 style="margin-bottom: 25px; color: var(--naranja-vitalidad);">
                    <span class="icon">üîó</span>Generador de Enlaces de Regalo
                </h2>
                <form id="generator-form">
                    <div class="form-group">
                        <label for="recipient-name-gen">Nombre del Receptor</label>
                        <input type="text" id="recipient-name-gen" name="recipient_name" placeholder="Ej: Ana P√©rez" required>
                    </div>
                    <div class="form-group">
                        <div class="checkbox-group">
                            <label for="is-kit">¬øEs un Kit de Recuerdos?</label>
                            <input type="checkbox" id="is-kit" name="is_kit">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Componentes del Regalo</label>
                        <div class="items-controls">
                            <button type="button" class="add-item-btn" onclick="addItem('video')">A√±adir Video</button>
                            <button type="button" class="add-item-btn" onclick="addItem('audio')">A√±adir Audio</button>
                            <button type="button" class="add-item-btn" onclick="addItem('pdf')">A√±adir PDF</button>
                            <button type="button" class="add-item-btn" onclick="addItem('link')">A√±adir Link</button>
                        </div>
                        <div id="items-container"></div>
                    </div>
                    <button type="submit" class="action-button" id="generate-button">
                        <span class="icon">‚ú®</span>Generar Enlace M√°gico
                    </button>
                </form>
            </div>
            <div id="generator-result" class="result-section"></div>
        </div>

        <!-- Tab: Env√≠o de Regalos -->
        <div id="sender-tab" class="tab-content">
            <div class="form-section">
                <h2 style="margin-bottom: 25px; color: var(--naranja-vitalidad);">
                    <span class="icon">üéÅ</span>Enviar Regalo Digital
                </h2>
                <form id="sender-form">
                    <div class="form-group">
                        <label for="recipient-name-send">Nombre del Destinatario</label>
                        <input type="text" id="recipient-name-send" name="recipient_name" placeholder="Ej: Ana P√©rez" required>
                    </div>
                    <div class="form-group">
                        <label for="recipient-email">Email del Destinatario</label>
                        <input type="email" id="recipient-email" name="recipient_email" placeholder="ana.perez@ejemplo.com" required>
                    </div>
                    <div class="form-group">
                        <label for="sender-name">Nombre del Remitente</label>
                        <input type="text" id="sender-name" name="sender_name" placeholder="Tu nombre" required>
                    </div>
                    <div class="form-group">
                        <label for="gift-url">URL del Regalo</label>
                        <input type="url" id="gift-url" name="gift_url" placeholder="Pega aqu√≠ el enlace generado o uno personalizado" required>
                        <small style="color: rgba(255, 255, 255, 0.7); margin-top: 5px; display: block;">
                            üí° Puedes usar un enlace generado en la pesta√±a anterior o pegar uno personalizado
                        </small>
                    </div>
                    
                    <!-- ================================================== -->
                    <!-- PASO 4.1: NUEVO CAMPO DE TEXTO A√ëADIDO AQU√ç -->
                    <!-- ================================================== -->
                    <div class="form-group">
                        <label for="order-id">N√∫mero de Pedido (Opcional)</label>
                        <input type="text" id="order-id" name="order_id" placeholder="Ej: PED-00123">
                    </div>
                    <!-- ================================================== -->

                    <button type="submit" class="action-button" id="send-button">
                        <span class="icon">üöÄ</span>Enviar Regalo M√°gico
                    </button>
                </form>
            </div>
            <div id="sender-result" class="result-section"></div>
        </div>
    </div>

    <script>
        const API_BASE_URL = '/api';
        let generatedLink = '';

        // Gesti√≥n de pesta√±as
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById(tabName + '-tab').classList.add('active');
            event.currentTarget.classList.add('active');
        }

        // Verificar estado del sistema
        async function checkHealth() {
            const healthResult = document.getElementById('health-result');
            try {
                const response = await fetch(`${API_BASE_URL}/health`);
                if (!response.ok) throw new Error('Respuesta no v√°lida del servidor');
                const data = await response.json();
                
                if (data.success) {
                    healthResult.innerHTML = '<div style="color: var(--verde-armonia); margin-top: 10px;">‚úÖ Sistema funcionando correctamente</div>';
                } else {
                    healthResult.innerHTML = `<div style="color: var(--magenta); margin-top: 10px;">‚ùå Error en el sistema: ${data.message}</div>`;
                }
            } catch (error) {
                healthResult.innerHTML = '<div style="color: var(--magenta); margin-top: 10px;">‚ùå No se pudo conectar con el servidor</div>';
            }
        }

        // Gesti√≥n de elementos del regalo
        function addItem(type) {
            const container = document.getElementById('items-container');
            const itemDiv = document.createElement('div');
            itemDiv.className = 'item';
            itemDiv.dataset.type = type;
            const itemTypes = {
                'video': { label: 'VIDEO', placeholder: 'Pega el enlace para compartir de Google Drive' },
                'audio': { label: 'AUDIO', placeholder: 'Pega el enlace para compartir de Google Drive' },
                'pdf': { label: 'PDF', placeholder: 'Pega el enlace para compartir de Google Drive' },
                'link': { label: 'LINK', placeholder: 'Pega la URL completa del enlace externo' }
            };
            const itemInfo = itemTypes[type];
            itemDiv.innerHTML = `
                <div class="item-label">${itemInfo.label}:</div>
                <input type="text" placeholder="${itemInfo.placeholder}" required>
                <button type="button" class="remove-item-btn" onclick="this.parentElement.remove()">‚úï</button>
            `;
            container.appendChild(itemDiv);
        }

        // Generar enlace
        document.getElementById('generator-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const generateButton = document.getElementById('generate-button');
            const resultSection = document.getElementById('generator-result');
            const recipientName = document.getElementById('recipient-name-gen').value;
            const isKit = document.getElementById('is-kit').checked;
            const items = Array.from(document.querySelectorAll('#items-container .item')).map(item => ({
                type: item.dataset.type,
                url: item.querySelector('input').value.trim()
            })).filter(item => item.url);

            if (!recipientName || items.length === 0) {
                showResult('generator', 'error', '‚ùå Error', 'El nombre del receptor y al menos un componente son obligatorios.');
                return;
            }

            generateButton.disabled = true;
            generateButton.innerHTML = '<span class="loading"></span>Generando enlace...';
            resultSection.style.display = 'none';

            try {
                const baseURL = "https://rohayhu-celebra-regalos.netlify.app/";
                const params = new URLSearchParams( );
                params.append('nombre', recipientName);
                params.append('remitente', "Rohayhu Celebra!"); // Remitente gen√©rico para el enlace
                params.append('kit', isKit);
                items.forEach((item, index) => {
                    params.append(`tipo${index + 1}`, item.type);
                    params.append(`url${index + 1}`, item.url);
                });

                generatedLink = `${baseURL}?${params.toString()}`;
                
                showResult('generator', 'success', 'üéâ ¬°Enlace generado exitosamente!', `
                    <div style="margin-bottom: 15px;">El enlace para <strong>${recipientName}</strong> est√° listo:</div>
                    <div class="generated-link">${generatedLink}</div>
                    <button class="copy-button" onclick="copyGeneratedLink()">üìã Copiar Enlace</button>
                    <button class="copy-button" onclick="useInSender()" style="margin-left: 10px;">üìß Usar para Enviar</button>
                `);

            } catch (error) {
                showResult('generator', 'error', '‚ùå Error inesperado', 'Ocurri√≥ un error al construir el enlace.');
            } finally {
                generateButton.disabled = false;
                generateButton.innerHTML = '<span class="icon">‚ú®</span>Generar Enlace M√°gico';
            }
        });

        // Enviar regalo
        document.getElementById('sender-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const sendButton = document.getElementById('send-button');
            const resultSection = document.getElementById('sender-result');
            
            // ====================================================================
            // PASO 4.2 (MODIFICADO): Leer el valor del nuevo campo "order-id"
            // ====================================================================
            const orderId = document.getElementById('order-id').value.trim();

            // Construir el objeto de datos
            const giftData = {
                recipient_name: document.getElementById('recipient-name-send').value,
                recipient_email: document.getElementById('recipient-email').value,
                sender_name: document.getElementById('sender-name').value,
                gift_url: document.getElementById('gift-url').value
            };

            // ====================================================================
            // PASO 4.3 (MODIFICADO): A√±adir el order_id al objeto solo si tiene un valor
            // ====================================================================
            if (orderId) {
                giftData.order_id = orderId;
            }

            sendButton.disabled = true;
            sendButton.innerHTML = '<span class="loading"></span>Enviando regalo...';
            resultSection.style.display = 'none';
            
            try {
                const response = await fetch(`${API_BASE_URL}/send-gift`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(giftData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showResult('sender', 'success', 'üéâ ¬°Regalo enviado exitosamente!', `
                        <div>El correo electr√≥nico ha sido enviado a <strong>${giftData.recipient_email}</strong></div>
                        <div style="margin-top: 10px; font-size: 0.9em; opacity: 0.8;">
                            Estado del env√≠o: ${result.status_code}
                        </div>
                    `);
                    e.target.reset();
                } else {
                    showResult('sender', 'error', '‚ùå Error al enviar el regalo', result.message);
                }
                
            } catch (error) {
                showResult('sender', 'error', '‚ùå Error de conexi√≥n', 'No se pudo conectar con el servidor. Por favor, intenta nuevamente.');
            } finally {
                sendButton.disabled = false;
                sendButton.innerHTML = '<span class="icon">üöÄ</span>Enviar Regalo M√°gico';
            }
        });

        // Funciones auxiliares
        function showResult(section, type, title, message) {
            const resultSection = document.getElementById(section + '-result');
            resultSection.style.display = 'block';
            resultSection.className = `result-section result-${type}`;
            resultSection.innerHTML = `
                <div style="font-size: 1.2em; margin-bottom: 10px;">${title}</div>
                <div>${message}</div>
            `;
        }

        function copyGeneratedLink() {
            if (generatedLink) {
                navigator.clipboard.writeText(generatedLink).then(() => {
                    alert('¬°Enlace copiado al portapapeles!');
                }, () => {
                    alert('Error al copiar el enlace. Por favor, c√≥pialo manualmente.');
                });
            }
        }

        function useInSender() {
            if (generatedLink) {
                switchTab('sender');
                document.getElementById('gift-url').value = generatedLink;
                const recipientName = document.getElementById('recipient-name-gen').value;
                if (recipientName) {
                    document.getElementById('recipient-name-send').value = recipientName;
                }
                showResult('sender', 'info', 'üìã Enlace copiado', 'El enlace generado se ha copiado al formulario de env√≠o. Completa los datos restantes y env√≠a el regalo.');
            }
        }

        window.addEventListener('load', checkHealth);
    </script>
</body>
</html>
